
spring:
  application:
    name: editor-server-snapshot

  # DataSource Configuration
  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5433/snapshot_db}
    username: ${SPRING_DATASOURCE_USERNAME:admin}
    password: ${SPRING_DATASOURCE_PASSWORD:admin}
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true

# gRPC Server Configuration
grpc:
  server:
    port: ${GRPC_SERVER_PORT:9091}

  share:
    service:
      host: ${SHARE_GRPC_HOST:localhost}
      port: ${SHARE_GRPC_PORT:50092}

  # JWT Configuration - OAuth2 Resource Server
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://auth-server:8080
          jwk-set-uri: http://auth-server:8080/.well-known/jwks.json

  kafka:
    bootstrap-servers: kafka-1:19092,kafka-2:19092,kafka-3:19092
    consumer:
      # Group ID will be set by KafkaConfig
      auto-offset-reset: earliest         # Start from beginning if no offset
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer

      # Single message processing for reliability
      max-poll-records: 1                  # Process one record at a time
      enable-auto-commit: false            # Manual commit for better control
      fetch-min-bytes: 1                   # Minimum fetch size
      fetch-max-wait: 500                  # Max wait for fetch

      # Connection settings
      session-timeout-ms: 30000
      heartbeat-interval-ms: 10000
      max-poll-interval-ms: 300000        # 5 minutes

      # Reliability settings
      properties:
        # Add retry configuration
        retry.backoff.ms: 1000
        retry.topic.dlq.enable: true

    # Single message listener
    listener:
      ack-mode: manual_immediate
      concurrency: 1                       # Single consumer for ordering

# Debezium configuration
debezium:
  topic:
    name: editor-server-main.public.crdt_operation_outbox_events
  consumer:
    group: editor-server-snapshot-cdc-consumer

# Logging configuration
logging:
  level:
    com.mmtext.editorserversnapshot: INFO
    org.apache.kafka: WARN
    org.springframework.kafka: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId}] %logger{36} - %msg%n"
# CORS Configuration
cors:
  allowed-origins: ${CORS_ORIGINS:http://client-app,http://localhost:4200}
  allowed-methods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,DELETE,OPTIONS}
  allowed-headers: ${CORS_ALLOWED_HEADERS:Content-Type,Authorization,X-CSRF-TOKEN,DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Range}
  allow-credentials: ${CORS_ALLOW_CREDENTIALS:true}
  exposed-headers: Set-Cookie
  max-age: ${CORS_MAX_AGE:3600}