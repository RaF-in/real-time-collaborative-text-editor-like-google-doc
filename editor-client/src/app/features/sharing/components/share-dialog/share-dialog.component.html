<h2 mat-dialog-title>Share "{{ data.documentTitle }}"</h2>

<mat-dialog-content class="dialog-content">
  <div class="share-content">
    <!-- Scrollable Top Section: Link + Share Form -->
    <div class="scrollable-top-section">
      <!-- Shareable Link Section -->
      <div class="link-section">
        <h3>Get link</h3>
        <div class="link-container">
          <mat-form-field class="link-field" appearance="outline">
            <mat-label>Anyone with the link</mat-label>
            <input matInput [value]="shareableLink()" readonly>
          </mat-form-field>
          <button mat-icon-button (click)="copyLink()" matTooltip="Copy link" class="copy-button">
            <mat-icon>content_copy</mat-icon>
          </button>
        </div>
      </div>

      <!-- Share with People Section -->
      <div class="people-share-section">
        <h3>Share with people</h3>
        <p class="info-text">Add people and choose their permission level</p>
        
        <form [formGroup]="shareForm" (ngSubmit)="share()">
          <div formArrayName="recipients">
            @for (recipient of recipients.controls; track $index) {
              <div class="recipient-row" [formGroupName]="$index">
                <mat-form-field class="email-field" appearance="outline">
                  <mat-label>Email address</mat-label>
                  <input matInput formControlName="email" placeholder="name@example.com">
                  @if (recipient.get('email')?.hasError('email')) {
                    <mat-error>Invalid email format</mat-error>
                  }
                </mat-form-field>
                
                <mat-form-field class="permission-field" appearance="outline">
                  <mat-label>Permission</mat-label>
                  <mat-select formControlName="permissionLevel">
                    @for (option of permissionOptions; track option.value) {
                      <mat-option [value]="option.value">
                        <mat-icon>{{ option.icon }}</mat-icon>
                        {{ option.label }}
                      </mat-option>
                    }
                  </mat-select>
                </mat-form-field>
                
                @if (recipients.length > 1) {
                  <button mat-icon-button type="button" (click)="removeRecipient($index)" matTooltip="Remove">
                    <mat-icon>close</mat-icon>
                  </button>
                }
              </div>
            }
          </div>
          
          @if (recipients.length < 50) {
            <button mat-button type="button" (click)="addRecipient()" class="add-button">
              <mat-icon>add</mat-icon>
              Add another person
            </button>
          }
          
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Message (optional)</mat-label>
            <textarea matInput formControlName="message" rows="3" 
                      placeholder="Add a message to include in the email"></textarea>
            <mat-hint>This message will be included in the email if notifications are enabled</mat-hint>
          </mat-form-field>
          
          <!-- Notify People Checkbox -->
          <div class="notify-section">
            <mat-checkbox formControlName="notifyPeople">
              Notify people
            </mat-checkbox>
            <p class="notify-hint">Send email notifications with the shareable link</p>
          </div>
          
          <!-- Share Button -->
          <div class="share-actions">
            <button mat-raised-button color="primary" type="submit"
                    [disabled]="shareForm.invalid || isSharing()" class="share-button">
              @if (isSharing()) {
                <mat-spinner diameter="20"></mat-spinner>
                Sharing...
              } @else {
                <mat-icon>share</mat-icon>
                Share
              }
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Scrollable Section: People with Access -->
    <div class="scrollable-people-section">
      <div class="people-section">
        <h3>People with access</h3>
        @if (sharingService.permissions(); as permissions) {
          @if (permissions.length === 0) {
            <p class="empty-state">No one else has access yet</p>
          } @else {
            <div class="permissions-list">
              @for (perm of permissions; track perm.id) {
                <div class="permission-item">
                  <div class="user-info">
                    <div class="avatar">{{ perm.userName.charAt(0).toUpperCase() }}</div>
                    <div>
                      <div class="user-name">{{ perm.userName }}</div>
                      <div class="user-email">{{ perm.userEmail }}</div>
                    </div>
                  </div>
                  <div class="permission-controls">
                    @if (perm.permissionLevel === PermissionLevel.OWNER) {
                      <span class="owner-badge">Owner</span>
                    } @else {
                      @if (perm.canChangePermission) {
                        <mat-form-field class="permission-select" appearance="outline">
                          <mat-select [value]="perm.permissionLevel" 
                                     (selectionChange)="changePermission(perm.userId, $event.value)">
                            @for (option of permissionOptions; track option.value) {
                              <mat-option [value]="option.value">{{ option.label }}</mat-option>
                            }
                          </mat-select>
                        </mat-form-field>
                      } @else {
                        <span class="permission-badge">{{ sharingService.getPermissionLabel(perm.permissionLevel) }}</span>
                      }
                      @if (perm.canRemove) {
                        <button mat-icon-button (click)="removePermission(perm.userId, perm.userEmail)" matTooltip="Remove access">
                          <mat-icon>close</mat-icon>
                        </button>
                      }
                    }
                  </div>
                </div>
              }
            </div>
          }
        }
      </div>
    </div>
  </div>
</mat-dialog-content>